(function($){const DEFAULTS={startDate:`${(new Date).getFullYear()}-01-01`,endDate:`${(new Date).getFullYear()}-12-31`,locale:"en-US",debug:false,classes:"border border-5 w-100 p-5",data:null,gutter:2,cellSize:14,colors:{0:"#ebedf0",.25:"#c6e48b",.5:"#7bc96f",.75:"#239a3b",1:"#196127"},titleFormatter(locale,date,count){return date.toLocaleDateString()+" - "+count},queryParams(p){return p}};function init($el,settings,draw){const setup=$.extend({},DEFAULTS,settings||{});setup.colors=setup.colors||DEFAULTS.colors;$el.data("heatmapSettings",setup);if(setup.debug){console.log("heatmap:init:",$el.data("heatmapSettings"))}if(draw){drawHeatmap($el)}}function getSettings($el){return $el.data("heatmapSettings")}async function getData($el){const settings=getSettings($el);if(Array.isArray(settings.data)){return Promise.resolve(settings.data)}let xhr=$el.data("xhr")||null;if(xhr&&xhr.abort){xhr.abort();xhr=null}const query={startDate:settings.startDate||`${(new Date).getFullYear()}-01-01`,endDate:settings.endDate||`${(new Date).getFullYear()}-12-31`};const customQuery=typeof settings.queryParams==="function"?settings.queryParams():{};const finalQuery={...customQuery,...query};try{xhr=$.ajax({url:settings.data,method:"GET",data:finalQuery,dataType:"json",beforeSend:()=>{if(settings.debug){console.log("getData: Anfrage gestartet.",finalQuery)}}});$el.data("xhr",xhr);await xhr;if(xhr.status===200){if(settings.debug){console.log("getData: Successful Response:",xhr.responseJSON)}$el.data("xhr",null);return xhr.responseJSON}else{throw new Error(`getData: Fehlerhafter Statuscode ${xhr.status}: ${xhr.statusText}`)}}catch(error){$el.data("xhr",null);if(settings.debug){console.error("getData:error",error)}throw error}}function calculateWeeks($el,startDate,endDate,firstDayOfWeek){const settings=getSettings($el);const start=getStartOfWeek(new Date(startDate),firstDayOfWeek);const end=getEndOfWeek(new Date(endDate),firstDayOfWeek);if(settings.debug){console.log("calculateWeeks:",{startDate:startDate,endDate:endDate,firstDayOfWeek:firstDayOfWeek,start:start,end:end})}const weeks=[];let currentDate=new Date(start);while(currentDate<=end){const currentWeek=[];for(let i=0;i<7;i++){currentWeek.push(new Date(currentDate));currentDate.setDate(currentDate.getDate()+1)}weeks.push(currentWeek)}return weeks}function getEndOfWeek(date,firstDayOfWeek){const startOfWeek=getStartOfWeek(date,firstDayOfWeek);const end=new Date(startOfWeek);end.setDate(startOfWeek.getDate()+6);end.setHours(23,59,59,999);return end}function getStartOfWeek(date,firstDayOfWeek){const diff=(date.getDay()-firstDayOfWeek+7)%7;const start=new Date(date);start.setDate(date.getDate()-diff);start.setHours(0,0,0,0);return start}function drawHeatmap($el){const settings=getSettings($el);if(!settings){console.error("Keine Heatmap-Einstellungen gefunden, Abbruch");return}if(settings.debug){console.log("heatmap:drawHeatmap")}const currentYear=(new Date).getFullYear();const startDate=settings.startDate||`${currentYear}-01-01`;const endDate=settings.endDate||`${currentYear}-12-31`;if(settings.debug){console.log(`Heatmap-Zeitraum: ${startDate} bis ${endDate}`)}const locale=settings.locale||"en-US";const dayFormatter=new Intl.DateTimeFormat(locale,{weekday:"short"});const monthFormatter=new Intl.DateTimeFormat(locale,{month:"short"});const firstDayOfWeek=getFirstDayOfWeek(locale);let gutter=settings.gutter||"2px";if(typeof gutter==="number"){gutter=`${gutter}px`}const cellSize=settings.cellSize||14;const cellSizePx=`${cellSize}px`;const weeks=calculateWeeks($el,startDate,endDate,firstDayOfWeek);$el.empty();getData($el).then(rawData=>{const data=Array.isArray(rawData)?rawData:JSON.parse(rawData);if(!Array.isArray(data)){throw new Error("Die erhaltenen Daten sind kein Array.")}if(settings.debug){console.log("heatmap:drawHeatmap:data",data)}const dataMap=new Map(data.map(entry=>[entry.date,entry.count]));const counts=data.map(entry=>entry.count);const minCount=Math.min(...counts);const maxCount=Math.max(...counts);const colorCache={};function getCachedColor(count){const cacheKey=`${count}-${minCount}-${maxCount}`;if(colorCache[cacheKey]){return colorCache[cacheKey]}const color=getContributionColor($el,count,minCount,maxCount);colorCache[cacheKey]=color;return color}weeks.forEach(week=>{week.forEach((day,index)=>{const dayKey=day.toISOString().split("T")[0];week[index]={date:day,count:dataMap.get(dayKey)||0}})});const heatmapContainer=$('<div class="heatmap-wrapper"></div>');heatmapContainer.css({display:"flex",flexDirection:"row",alignItems:"flex-start",gap:gutter});const dayLabelColumn=$('<div class="day-labels"></div>');dayLabelColumn.css({display:"grid",gridTemplateRows:`${cellSizePx} repeat(7, ${cellSizePx})`,marginRight:gutter,textAlign:"right",rowGap:gutter});const heatmapYear=new Date(settings.startDate||(new Date).getFullYear()).getFullYear();dayLabelColumn.append("<div></div>");Array.from({length:7},(_,i)=>(firstDayOfWeek+i)%7).forEach(dayIndex=>{const tempDate=new Date(heatmapYear,0,Number(dayIndex));const label=$('<div class="day-label"></div>');label.text(dayFormatter.format(tempDate));label.css({fontSize:"10px",color:"#666",lineHeight:cellSizePx});dayLabelColumn.append(label)});heatmapContainer.append(dayLabelColumn);const heatmapGrid=$('<div class="heatmap"></div>');heatmapGrid.css({display:"flex",gap:gutter});let lastRenderedMonth=-1;weeks.forEach(week=>{const weekColumn=$('<div class="heatmap-week"></div>');weekColumn.css({display:"grid",gridTemplateRows:`${cellSizePx} repeat(7, ${cellSizePx})`,rowGap:gutter});const currentMonth=week.find(d=>d.date&&d.date.getDate()===1)?.date.getMonth();if(currentMonth!==undefined&&currentMonth!==lastRenderedMonth){lastRenderedMonth=currentMonth;const monthLabel=$('<div class="month-label"></div>');monthLabel.text(monthFormatter.format(week.find(d=>d.date&&d.date.getDate()===1).date));monthLabel.css({textAlign:"center",fontSize:`${Math.min(cellSize-4,12)}px`,lineHeight:cellSizePx,height:cellSizePx,width:cellSizePx});weekColumn.append(monthLabel)}else{weekColumn.append('<div style="height: '+cellSizePx+';"></div>')}week.forEach(dayEntry=>{const cell=$('<div class="heatmap-cell"></div>');cell.css({width:cellSizePx,height:cellSizePx,backgroundColor:getCachedColor(dayEntry.count),borderRadius:"2px",cursor:"pointer"});if(dayEntry.date){cell.attr("data-toggle","tooltip").attr("data-html",true).attr("data-bs-toggle","tooltip").attr("data-bs-html",true).attr("title",settings.titleFormatter(settings.locale,dayEntry.date,dayEntry.count)||"")}weekColumn.append(cell)});heatmapGrid.append(weekColumn)});heatmapContainer.append(heatmapGrid);$el.append(heatmapContainer)}).catch(err=>{console.error("Fehler beim Laden der Daten:",err);$el.append(`<div class="heatmap-error">${err.message||err}</div>`)}).finally(()=>{$el.trigger("post.heatmap",[$el])})}function getFirstDayOfWeek(locale){try{const formatter=new Intl.DateTimeFormat(locale,{weekday:"long"});const sampleDate=new Date(2023,0,1);const dayName=formatter.format(sampleDate);return dayName.toLowerCase().startsWith("sun")?0:1}catch(error){console.error("Fehler bei getFirstDayOfWeek:",error);return 1}}function getContributionColor($el,count,minCount,maxCount){const settings=getSettings($el)||{colors:{}};if(settings.debug){console.log("getContributionColor:settings",getSettings($el))}if(!settings.colors||Object.keys(settings.colors).length===0){if(settings.debug){console.error("Fehlende Farb-Einstellungen in settings:",settings)}return"#ff0000"}if(count===0){return settings.colors["0"]}const range=maxCount-minCount||1;let percentage=(count-minCount)/range;percentage=Math.max(0,Math.min(percentage,1));const colorKeys=Object.keys(settings.colors).map(Number).sort((a,b)=>a-b);const matchedKey=colorKeys.find(key=>percentage<=key)||Math.max(...colorKeys);if(settings.debug){console.log({count:count,minCount:minCount,maxCount:maxCount,range:range,percentage:percentage,matchedKey:matchedKey,color:settings.colors[matchedKey]})}return settings.colors[matchedKey]||settings.colors["1"]}$.fn.heatmap=function(options,params){if($(this).length>1){return $(this).each(function(i,element){return $(element).heatmap(options,params)})}const $element=$(this);const methodCalled=typeof options==="string";const isInitialized=$element.data("heatmapSettings");if(!isInitialized){init($element,options,!methodCalled)}if(!methodCalled){return $element}switch(options){case"updateOptions":{const setup=$element.data("heatmapSettings");if(setup.debug){console.log("heatmap:updateOptions",params)}$element.data("heatmapSettings",$.extend({},DEFAULTS,setup,params||{}));drawHeatmap($element)}break}return $element}})(jQuery);